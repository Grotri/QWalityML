name: Conventional Commits Check
on: [push, pull_request]

jobs:
  check-commits:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate commit messages
        run: |
          HEADER_PATTERN='^(chore|docs|feat|fix|refactor|revert|style|test)(\([a-z-]+\))?: .+'
          FOOTER_PATTERN='^Fixes: [A-Z]+-[0-9]+$'
          
          ERROR_MSG="❌ Неверный формат коммита! Требования:\n\
          1. Первая строка: <тип>(<область>): <описание>\n\
             Пример: 'fix: исправить баг' или 'feat(api): добавить метод'\n\
             Допускается: 'fix: fix typo'\n\
          2. Последняя строка: 'Fixes: QW-52' (обязательно)\n\
          3. Между ними может быть любой текст"

          if [ "$GITHUB_EVENT_NAME" = "push" ]; then
            BASE_SHA=$(git rev-parse $GITHUB_REF~1)
            HEAD_SHA=$(git rev-parse $GITHUB_SHA)
          else
            BASE_SHA=$(git rev-parse $GITHUB_BASE_REF)
            HEAD_SHA=$(git rev-parse $GITHUB_HEAD_REF)
          fi

          git log --format=%B $BASE_SHA..$HEAD_SHA | awk -v RS= -v FS="\n" '{
            header = $1
            footer = $NF
            if (header !~ /'"$HEADER_PATTERN"'/ || footer !~ /'"$FOOTER_PATTERN"'/) {
              print "❌ Ошибка в коммите:"
              print "---"
              print $0
              print "---"
              print "'"$ERROR_MSG"'"
              exit 1
            }
          }'
