name: Conventional Commits Check
on: [push, pull_request]

jobs:
  check-commits:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate commit messages
        run: |
          TYPES="build|chore|ci|docs|feat|fix|perf|refactor|revert|style|test"
          HEADER_PATTERN="^($TYPES)(\([a-z-]+\))?: .+"
          FOOTER_PATTERN="^Fixes: [A-Z]+-[0-9]+$"
          
          ERROR_MSG="❌ Неверный формат коммита! Требования:
          1. Первая строка: <тип>(<область>): <описание>
             Пример: 'fix: исправить баг' или 'feat(api): добавить метод'
             Допускается: 'fix: fix regex'
          2. Последняя строка: 'Fixes: QW-52' (обязательно)
          3. Между ними может быть любой текст (игнорируется)"

          if [ "$GITHUB_EVENT_NAME" = "push" ]; then
            COMMITS=$(git log --format=%B $GITHUB_REF~1..$GITHUB_SHA)
          else
            COMMITS=$(git log --format=%B $GITHUB_BASE_REF..$GITHUB_HEAD_REF)
          fi

          while read -r -d '' commit; do
            first_line=$(echo "$commit" | head -n 1 | grep -v '^$')
            last_line=$(echo "$commit" | tail -n 1 | grep -v '^$')
            
            # Проверяем условия
            if ! [[ "$first_line" =~ $HEADER_PATTERN ]] || ! [[ "$last_line" =~ $FOOTER_PATTERN ]]; then
              echo "❌ Ошибка в коммите:"
              echo "---"
              echo "$commit"
              echo "---"
              echo "$ERROR_MSG"
              exit 1
            fi
          done < <(echo "$COMMITS" | awk -v RS='\n\n' -v ORS='\0' '1')
