name: Conventional Commits Check
on: [push, pull_request]

jobs:
  check-commits:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate commit messages
        run: |
          HEADER_PATTERN='^(build|chore|ci|docs|feat|fix|perf|refactor|revert|style|test)(\([a-z-]+\))?: [a-zA-Z].+'
          FULL_PATTERN="${HEADER_PATTERN}(\n\n.*)?(\n\nFixes: [A-Z]+-[0-9]+)?$"
          
          ERROR_MSG="❌ Неверный формат коммита! Примеры:\n\
          fix: исправить проверку коммитов\n\n\
          Fixes: QW-52\n\n\
          ИЛИ\n\
          feat(api): добавить новую функцию\n\n\
          Подробное описание изменений\n\n\
          Fixes: QW-53\n\n\
          Требования:\n\
          - Тип (feat, fix и др.)\n\
          - Описание после двоеточия\n\
          - 'Fixes: QW-XX' в конце (обязательно)"

          # Получаем диапазон коммитов для проверки
          if [ "$GITHUB_EVENT_NAME" = "push" ]; then
            BASE_SHA=$(git rev-parse $GITHUB_REF~1)
            HEAD_SHA=$(git rev-parse $GITHUB_SHA)
          else
            BASE_SHA=$(git rev-parse $GITHUB_BASE_REF)
            HEAD_SHA=$(git rev-parse $GITHUB_HEAD_REF)
          fi

          # Проверяем каждый коммит целиком
          git log --format=%B $BASE_SHA..$HEAD_SHA | awk -v RS= '{print}' | while read -r commit; do
            if [[ ! "$commit" =~ $FULL_PATTERN ]]; then
              echo -e "$ERROR_MSG"
              echo -e "\nОшибка в коммите:\n---\n$commit\n---"
              exit 1
            fi
          done
