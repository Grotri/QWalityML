name: Conventional Commits Check
on: [push, pull_request]

jobs:
  check-commits:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate commit messages
        run: |
          PATTERN='^(chore|docs|feat|fix|refactor|revert|style|test)(\([a-z-]+\))?: [a-zA-Z].+$'
          BODY_PATTERN='(\n\n.*)?'
          FOOTER_PATTERN='(\n\nFixes: [A-Z]+-[0-9]+)?$'
          FULL_PATTERN="${PATTERN}${BODY_PATTERN}${FOOTER_PATTERN}"
          
          ERROR_MSG="❌ Invalid commit format! Примеры:\n\
          fix: add new feature\n\
          или\n\
          fix(ui): Add new feature\n\n\
          Описание изменений (опционально)\n\n\
          Fixes: QW-52\n\n\
          Требования:\n\
          - Тип (feat, fix и др.)\n\
          - Описание после двоеточия\n\
          - Задача в формате 'Fixes: QW-52' (обязательно)"
          
          if [ "$GITHUB_EVENT_NAME" = "push" ]; then
            BASE_SHA=$(git rev-parse $GITHUB_REF~1)
            HEAD_SHA=$(git rev-parse $GITHUB_SHA)
          else
            BASE_SHA=$(git rev-parse $GITHUB_BASE_REF)
            HEAD_SHA=$(git rev-parse $GITHUB_HEAD_REF)
          fi

          git log --format=%B $BASE_SHA..$HEAD_SHA | while IFS= read -r line; do
            if [ -n "$line" ] && [[ ! "$line" =~ ^# ]] && [[ ! "${line}" =~ ${FULL_PATTERN} ]]; then
              echo -e "$ERROR_MSG"
              echo -e "\nНайден невалидный коммит:\n---\n${line}\n---"
              exit 1
            fi
          done
