name: Conventional Commits Check
on: [push, pull_request]

jobs:
  check-commits:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate commit messages
        run: |
          check_commit() {
            local commit=$1
            
            local first_line=$(echo "$commit" | grep -m 1 -v '^$')
            
            local last_line=$(echo "$commit" | tail -n 1 | grep -v '^$')
            
            if ! echo "$first_line" | grep -qE '^(build|chore|ci|docs|feat|fix|perf|refactor|revert|style|test)(\([a-z-]+\))?: .+'; then
              return 1
            fi
            
            if ! echo "$last_line" | grep -qE '^Fixes: [A-Z]+-[0-9]+$'; then
              return 1
            fi
            
            return 0
          }

          if [ "$GITHUB_EVENT_NAME" = "push" ]; then
            COMMITS_RANGE="$GITHUB_REF~1..$GITHUB_SHA"
          else
            COMMITS_RANGE="$GITHUB_BASE_REF..$GITHUB_HEAD_REF"
          fi

          git log --format=%B $COMMITS_RANGE | awk -v RS='' '{print}' | while read -r commit; do
            if ! check_commit "$commit"; then
              echo "❌ Ошибка в коммите:"
              echo "---"
              echo "$commit"
              echo "---"
              echo "❌ Неверный формат коммита! Требования:"
              echo "1. Первая строка: <тип>(<область>): <описание>"
              echo "   Пример: 'fix: исправить баг' или 'feat(api): добавить метод'"
              echo "   Допускается: 'fix: fix regex'"
              echo "2. Последняя строка: 'Fixes: QW-52' (обязательно)"
              echo "3. Между ними может быть любой текст"
              exit 1
            fi
          done
